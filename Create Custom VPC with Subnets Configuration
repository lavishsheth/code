#!/bin/bash

# ---------------------------------------------------
# Custom VPC Setup Script
# ---------------------------------------------------
# Deletes default VPC
# Creates custom VPC
# Creates subnets in us-east1 and asia-southeast1
# ---------------------------------------------------

set -e

# Variables
NETWORK_NAME=custom-vpc
SUBNET_US=subnet-us-east1
SUBNET_ASIA=subnet-asia-southeast1
REGION1=us-east1
REGION2=asia-southeast1
RANGE1=10.0.1.0/24
RANGE2=10.0.2.0/24

echo "Removing firewall rules from default network..."

FIREWALL_RULES=$(gcloud compute firewall-rules list --filter="network=default" --format="value(name)")

for RULE in $FIREWALL_RULES
do
  gcloud compute firewall-rules delete "$RULE" --quiet
done

echo "Deleting default VPC network..."
gcloud compute networks delete default --quiet

echo "Creating custom VPC network..."
gcloud compute networks create $NETWORK_NAME --subnet-mode=custom

echo "Creating subnet in us-east1..."
gcloud compute networks subnets create $SUBNET_US --network=$NETWORK_NAME --region=$REGION1 --range=$RANGE1

echo "Creating subnet in asia-southeast1..."
gcloud compute networks subnets create $SUBNET_ASIA --network=$NETWORK_NAME --region=$REGION2 --range=$RANGE2

echo "Custom VPC setup completed successfully."

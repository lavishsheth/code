# ---------------------------------------------
# Cloud CDN Setup for GCS Bucket (HTTP)
# ---------------------------------------------

# Set required variables
BUCKET_NAME="your-gcs-bucket-name"        # Replace with your existing GCS bucket name
BACKEND_BUCKET="static-backend-bucket"    # Backend bucket resource name
URL_MAP="cdn-map"                         # URL map name
PROXY="cdn-http-proxy"                    # Target HTTP proxy name
FORWARDING_RULE="cdn-http-rule"           # Global forwarding rule name

# 1️⃣ Create Backend Bucket and Enable Cloud CDN
gcloud compute backend-buckets create $BACKEND_BUCKET --gcs-bucket-name=$BUCKET_NAME --enable-cdn

# 2️⃣ Create URL Map and Attach Backend Bucket
gcloud compute url-maps create $URL_MAP --default-backend-bucket=$BACKEND_BUCKET

# 3️⃣ Create Target HTTP Proxy
gcloud compute target-http-proxies create $PROXY --url-map=$URL_MAP

# 4️⃣ Create Global Forwarding Rule (Port 80)
gcloud compute forwarding-rules create $FORWARDING_RULE --global --target-http-proxy=$PROXY --ports=80

# 5️⃣ Retrieve External IP Address
IP_ADDRESS=$(gcloud compute forwarding-rules describe $FORWARDING_RULE --global --format="value(IPAddress)")

echo "Cloud CDN is available at: http://$IP_ADDRESS"

# 6️⃣ Verify objects inside the bucket
gsutil ls gs://$BUCKET_NAME/images/

# 7️⃣ Test file download from CDN
curl -o nature.png http://$IP_ADDRESS/images/nature.png
